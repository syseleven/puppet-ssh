#WARNING: This file is auto-generated by puppet from a template
# This template can be found in ssh/templates/sshd_config.erb
#
# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/local/bin:/bin:/usr/bin

Port <%= scope['ssh::listen_port'] %>
Protocol 2
AddressFamily <%= scope['ssh::address_family'] %>

<% if scope['ssh::listen_ip'].class == Array -%>
<% scope['ssh::listen_ip'].each do |value| -%>
<% if value == "internal" or value == "external" -%>
<% if scope.lookupvar('ipaddress_' + value) -%>
ListenAddress <%= scope.lookupvar('ipaddress_' + value) %>
<% end -%>
<% else -%>
ListenAddress <%= value %>
<% end -%>
<% end -%>
<% else -%>
<% if scope['ssh::listen_ip'] == "internal" or scope['ssh::listen_ip'] == "external" -%>
<% if scope.lookupvar('ipaddress_' + scope['ssh::listen_ip']) -%>
ListenAddress <%= scope.lookupvar('ipaddress_' + scope['ssh::listen_ip']) %>
<% end -%>
<% else -%>
ListenAddress <%= scope['ssh::listen_ip'] %>
<% end -%>
<% end -%>

# HostKeys for protocol version 2
<% if @host_keys.class == Array -%>
<% @host_keys.each do |key| -%>
HostKey <%= key %>
<% end -%>
<% else -%>
HostKey <%= @host_keys %>
<% end -%>

<% if @kernel == "Linux"-%>
SyslogFacility AUTHPRIV
<%else-%>
SyslogFacility auth
<%end-%>
LogLevel <%= @log_level %>

# Accept locale-related environment variables
AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES 
AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT 
AcceptEnv LC_IDENTIFICATION LC_ALL
#UseDNS yes

IgnoreRhosts yes
PermitRootLogin <%= @rootallowed and 'yes' or 'no' %>
Subsystem      sftp    <%= @subsystem_sftp %>
# This three variables UsePAM, PasswordAuthentication and ChallengeResponseAuthentication
<% if @passwordallowed -%>
# enable the password authentication.
<% if @kernel == "Linux" and @osfamily != 'RedHat' -%>
UsePAM yes
<%end-%>
PasswordAuthentication yes
ChallengeResponseAuthentication yes
<%else-%>
# disable the password authentication.
<% if @kernel == "Linux" and @osfamily != 'RedHat' -%>
<% if @usepam -%>
UsePAM yes
<%else-%>
UsePAM no
<%end-%>
<%end-%>
PasswordAuthentication no
ChallengeResponseAuthentication no
<%end -%>
<% if @ciphers -%>
Ciphers <%= @ciphers %>
<% end %>
<% if @macs -%>
MACs <%= @macs %>
<% end %>
<% if @real_kexalgorithms -%>
KexAlgorithms <%= @real_kexalgorithms %>
<% end %>
X11Forwarding <%= @x11forwarding and 'yes' or 'no' %>
<% if @template_vars -%>
<% @template_vars.each do |key,val| %>
<%= key%> <%= val%>
<% end -%>
<% end -%>
<% if @sftp_chroots -%>

<% @sftp_chroots.each do |username,values| -%>
Match User <%= username %>
<% if values -%>
<% if values.kind_of?(Hash) -%>
<% if not values["ChrootDirectory"] -%>
  ChrootDirectory           /home/<%= username %>
<% end -%>
<% if not values["ForceCommand"] -%>
  ForceCommand              internal-sftp
<% end -%>
<% if not values["X11Forwarding"] -%>
  X11Forwarding             no
<% end -%>
<% if not values["AllowTcpForwarding"] -%>
  AllowTcpForwarding        no
<% end -%>
<% values.each do |k,v| -%>
  <%= k.ljust(25) %> <%= v %>
<% end -%>
<% else -%>
  ChrootDirectory           <%= values %>
  ForceCommand              internal-sftp
  X11Forwarding             no
  AllowTcpForwarding        no
<% end -%>
<% else -%>
  ChrootDirectory           /home/<%= username %>
  ForceCommand              internal-sftp
  X11Forwarding             no
  AllowTcpForwarding        no
<% end -%>
<% end -%>
<% end -%>
